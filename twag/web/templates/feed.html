{% extends "base.html" %}

{% block title %}Feed - Twag{% endblock %}

{% block content %}
<div class="layout-grid">
    <!-- Filter Drawer (mobile) / Sidebar (desktop) -->
    <aside class="filters-panel">
        <!-- Mobile Drawer -->
        <div id="filter-drawer" class="drawer" role="dialog" aria-modal="true" aria-labelledby="filter-drawer-title">
            <div class="drawer-header">
                <h3 id="filter-drawer-title" class="panel-title">Filters</h3>
                <button type="button" id="drawer-close-btn" class="drawer-close" aria-label="Close filters">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <form id="filter-form" class="drawer-body form-stack" hx-get="/feed" hx-target="#tweet-feed" hx-swap="innerHTML" hx-trigger="change delay:300ms">
                <input type="hidden" name="sort" id="sort-input" value="relevance">
                <!-- Time range -->
                <div class="form-field">
                    <label class="field-label">Time</label>
                    <select name="since" class="select">
                        <option value="">All time</option>
                        <option value="today" selected>Today</option>
                        <option value="24h">Last 24h</option>
                        <option value="7d">Last 7 days</option>
                        <option value="30d">Last 30 days</option>
                    </select>
                </div>

                <!-- Min score -->
                <div class="form-field">
                    <label class="field-label">Min Score</label>
                    <select name="min_score" class="select">
                        <option value="">Any</option>
                        <option value="3" selected>3+</option>
                        <option value="5">5+</option>
                        <option value="6">6+</option>
                        <option value="7">7+ (High Signal)</option>
                        <option value="8">8+</option>
                        <option value="9">9+</option>
                    </select>
                </div>

                <!-- Signal tier -->
                <div class="form-field">
                    <label class="field-label">Signal Tier</label>
                    <select name="signal_tier" class="select">
                        <option value="">All tiers</option>
                        <option value="high_signal">High Signal</option>
                        <option value="market_relevant">Market Relevant</option>
                        <option value="news">News</option>
                        <option value="noise">Noise</option>
                    </select>
                </div>

                <!-- Category -->
                <div class="form-field">
                    <label class="field-label">Category</label>
                    <select name="category" class="select" id="category-select">
                        <option value="">All categories</option>
                    </select>
                </div>

                <!-- Ticker -->
                <div class="form-field">
                    <label class="field-label">Ticker</label>
                    <input type="text" name="ticker" placeholder="e.g., SPY"
                           class="input uppercase"
                           maxlength="10">
                </div>

                <!-- Author -->
                <div class="form-field">
                    <label class="field-label">Author</label>
                    <input type="text" name="author" placeholder="@handle"
                           class="input">
                </div>

                <!-- Bookmarked only -->
                <div class="form-field">
                    <label class="checkbox-row">
                        <input type="checkbox" name="bookmarked" value="true" class="checkbox">
                        Bookmarked only
                    </label>
                </div>

                <button type="button" onclick="resetFilters()" class="btn btn-ghost w-full">
                    Reset filters
                </button>
            </form>
        </div>
    </aside>

    <!-- Main feed -->
    <div class="flex-1">
        <div class="feed-toolbar">
            <div class="feed-toolbar-title">
                <h2 class="section-title">Tweet Feed</h2>
                <div class="section-meta">
                    <span id="tweet-count"></span>
                </div>
            </div>
            <div class="feed-toolbar-actions">
                <span class="feed-toolbar-label">Sort</span>
                <select id="sort-select" class="select" data-default="relevance">
                    <option value="relevance">Relevance</option>
                    <option value="latest">Latest</option>
                </select>
            </div>
        </div>

        <!-- Loading indicator -->
        <div class="loading-indicator text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-gray-200 border-t-teal-500"></div>
            <p class="mt-2 text-gray-500">Loading tweets...</p>
        </div>

        <!-- Tweet feed container -->
        <div id="tweet-feed"></div>
    </div>
</div>

<!-- Reaction modal -->
<div id="reaction-modal" class="modal fixed inset-0 hidden items-center justify-center z-50">
    <div class="modal-card max-w-md w-full mx-4">
        <h3 class="text-lg font-semibold mb-4">Add Feedback</h3>
        <form id="reaction-form">
            <input type="hidden" name="tweet_id" id="reaction-tweet-id">
            <input type="hidden" name="reaction_type" id="reaction-type">

            <div class="form-field">
                <label class="field-label">Reason (optional)</label>
                <textarea name="reason" id="reaction-reason" rows="3"
                          class="textarea"
                          placeholder="Why should this be rated differently?"></textarea>
            </div>

            <!-- For mute actions -->
            <div id="mute-target-field" class="form-field hidden">
                <label class="field-label">Target</label>
                <input type="text" name="target" id="reaction-target"
                       class="input">
            </div>

            <div class="flex justify-end space-x-2">
                <button type="button" onclick="closeReactionModal()" class="btn btn-ghost">
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                    Submit
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Load categories for filter
    async function loadCategories() {
        try {
            const resp = await fetch('/api/categories');
            const data = await resp.json();
            const select = document.getElementById('category-select');
            data.categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.name;
                option.textContent = `${cat.name} (${cat.count})`;
                select.appendChild(option);
            });
        } catch (e) {
            console.error('Failed to load categories:', e);
        }
    }
    loadCategories();

    const SORT_STORAGE_KEY = 'twag.feed.sort';

    function applySavedSort() {
        const select = document.getElementById('sort-select');
        const hidden = document.getElementById('sort-input');
        if (!select || !hidden) return;
        const saved = localStorage.getItem(SORT_STORAGE_KEY);
        const fallback = select.dataset.default || 'relevance';
        const value = saved || fallback;
        select.value = value;
        hidden.value = value;
    }

    function handleSortChange() {
        const select = document.getElementById('sort-select');
        const hidden = document.getElementById('sort-input');
        const form = document.getElementById('filter-form');
        if (!select || !hidden) return;
        hidden.value = select.value;
        localStorage.setItem(SORT_STORAGE_KEY, select.value);
        if (form && window.htmx) {
            htmx.trigger(form, 'change');
        }
    }

    // Reset filters
    function resetFilters() {
        const form = document.getElementById('filter-form');
        form.reset();
        const select = document.getElementById('sort-select');
        const hidden = document.getElementById('sort-input');
        if (select && hidden) {
            const fallback = select.dataset.default || 'relevance';
            select.value = fallback;
            hidden.value = fallback;
            localStorage.removeItem(SORT_STORAGE_KEY);
        }
        htmx.trigger(form, 'change');
    }

    document.addEventListener('DOMContentLoaded', function() {
        applySavedSort();
        const select = document.getElementById('sort-select');
        if (select) {
            select.addEventListener('change', handleSortChange);
        }
        const form = document.getElementById('filter-form');
        if (form && window.htmx) {
            htmx.trigger(form, 'change');
        }
    });

    // Reaction handling
    function openReactionModal(tweetId, reactionType, author) {
        document.getElementById('reaction-tweet-id').value = tweetId;
        document.getElementById('reaction-type').value = reactionType;
        document.getElementById('reaction-reason').value = '';
        document.getElementById('reaction-target').value = author || '';

        // Show/hide mute target field
        const muteField = document.getElementById('mute-target-field');
        if (reactionType === 'x_author' || reactionType === 'x_topic') {
            muteField.classList.remove('hidden');
        } else {
            muteField.classList.add('hidden');
        }

        document.getElementById('reaction-modal').classList.remove('hidden');
        document.getElementById('reaction-modal').classList.add('flex');
    }

    function closeReactionModal() {
        document.getElementById('reaction-modal').classList.add('hidden');
        document.getElementById('reaction-modal').classList.remove('flex');
    }

    // Quick reaction (no modal)
    async function quickReact(tweetId, reactionType) {
        try {
            const resp = await fetch('/api/react', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    tweet_id: tweetId,
                    reaction_type: reactionType
                })
            });
            const data = await resp.json();
            if (data.error) {
                showToast(data.error, 'error');
            } else {
                showToast('Reaction added', 'success');
                // Update button state
                const btn = document.querySelector(`[data-tweet="${tweetId}"][data-reaction="${reactionType}"]`);
                if (btn) btn.classList.add('active');
            }
        } catch (e) {
            showToast('Failed to add reaction', 'error');
        }
    }

    // Reaction form submit
    document.getElementById('reaction-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = {
            tweet_id: formData.get('tweet_id'),
            reaction_type: formData.get('reaction_type'),
            reason: formData.get('reason') || null,
            target: formData.get('target') || null
        };

        try {
            const resp = await fetch('/api/react', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            const result = await resp.json();
            if (result.error) {
                showToast(result.error, 'error');
            } else {
                showToast(result.message || 'Reaction added', 'success');
                closeReactionModal();
            }
        } catch (e) {
            showToast('Failed to add reaction', 'error');
        }
    });

    // Close modal on escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeReactionModal();
    });

    // Click outside modal to close
    document.getElementById('reaction-modal').addEventListener('click', function(e) {
        if (e.target === this) closeReactionModal();
    });

    // Analyze tweet
    async function analyzeTweet(tweetId) {
        showToast('Analyzing tweet...', 'info');
        try {
            const resp = await fetch(`/api/analyze/${tweetId}`, {method: 'POST'});
            const data = await resp.json();
            if (data.error) {
                showToast(data.error, 'error');
            } else {
                // Show analysis in a modal or expand the tweet
                alert('Analysis:\n\n' + data.analysis);
            }
        } catch (e) {
            showToast('Analysis failed', 'error');
        }
    }
</script>
{% endblock %}
