<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#0f766e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>{% block title %}Twag{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- htmx -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="stylesheet" href="/static/app.css">
    {% block head %}{% endblock %}
</head>
<body class="app-body has-bottom-nav">
    <div class="app-shell">
        <!-- Navigation -->
        <nav class="app-nav">
            <div class="app-container nav-inner">
                <div class="flex justify-between w-full">
                    <div class="flex">
                        <a href="/" class="nav-brand">
                            Twag
                        </a>
                        <div class="hidden sm:ml-6 sm:flex nav-links">
                            <a href="/" class="nav-link">
                                Feed
                            </a>
                            <a href="/prompts" class="nav-link">
                                Prompts
                            </a>
                            <a href="/context-commands" class="nav-link">
                                Context
                            </a>
                        </div>
                    </div>
                    <div class="flex items-center nav-meta">
                        <span class="text-sm text-gray-500" id="stats-indicator"></span>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main content -->
        <main class="app-container app-main">
            {% block content %}{% endblock %}
        </main>
    </div>

    <!-- Drawer overlay (for filter drawer on mobile) -->
    <div id="drawer-overlay" class="drawer-overlay" aria-hidden="true"></div>

    <!-- Bottom Navigation (mobile only) -->
    <nav class="bottom-nav" aria-label="Mobile navigation">
        <a href="/" class="bottom-nav-item{% if request.path == '/' %} is-active{% endif %}" aria-current="{% if request.path == '/' %}page{% endif %}">
            <svg class="bottom-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/>
            </svg>
            <span>Feed</span>
        </a>
        <button type="button" class="bottom-nav-item" id="filter-toggle-btn" aria-expanded="false" aria-controls="filter-drawer">
            <svg class="bottom-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
            </svg>
            <span>Filters</span>
        </button>
        <a href="/prompts" class="bottom-nav-item{% if request.path == '/prompts' %} is-active{% endif %}" aria-current="{% if request.path == '/prompts' %}page{% endif %}">
            <svg class="bottom-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
            </svg>
            <span>Prompts</span>
        </a>
        <a href="/context-commands" class="bottom-nav-item{% if request.path == '/context-commands' %} is-active{% endif %}" aria-current="{% if request.path == '/context-commands' %}page{% endif %}">
            <svg class="bottom-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
            </svg>
            <span>Context</span>
        </a>
    </nav>

    <!-- Toast notifications -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script src="/static/drawer.js"></script>
    <script src="/static/modal.js"></script>
    <script>
        function formatRelativeOrLocalTime(isoString) {
            const date = new Date(isoString);
            if (Number.isNaN(date.getTime())) return isoString;

            const now = new Date();
            const diffMs = now - date;
            const sixHoursMs = 6 * 60 * 60 * 1000;

            if (diffMs >= 0 && diffMs < sixHoursMs) {
                const minutes = Math.floor(diffMs / 60000);
                if (minutes < 1) return "just now";
                if (minutes < 60) return `${minutes}m ago`;
                const hours = Math.floor(diffMs / 3600000);
                return `${hours}h ago`;
            }

            return date.toLocaleString(undefined, {
                month: "short",
                day: "numeric",
                hour: "2-digit",
                minute: "2-digit",
            });
        }

        function renderLocalTimes(root = document) {
            const nodes = root.querySelectorAll(".js-local-time");
            nodes.forEach((node) => {
                const iso = node.getAttribute("data-iso");
                if (!iso) return;
                node.textContent = formatRelativeOrLocalTime(iso);
            });
        }

        // Toast notification helper
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = {
                info: 'bg-blue-500',
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500'
            };
            toast.className = `${colors[type]} text-white px-4 py-2 rounded shadow-lg transition-opacity duration-300`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // htmx event handlers
        document.body.addEventListener('htmx:afterRequest', function(evt) {
            if (evt.detail.failed) {
                showToast('Request failed', 'error');
            }
        });

        document.body.addEventListener('htmx:afterSwap', function(evt) {
            if (evt.detail && evt.detail.target) {
                renderLocalTimes(evt.detail.target);
            }
        });

        document.body.addEventListener('htmx:responseError', function(evt) {
            showToast('Server error', 'error');
        });

        document.addEventListener('DOMContentLoaded', function() {
            renderLocalTimes();
        });
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
